<html xmlns:wicket="http://wicket.apache.org/">
<head>

</head>
<body>
<wicket:extend>
<div id="geoserverUrl" class="x-hide-display"><wicket:message key="geoserver"></wicket:message></div>
<div id="apiUrl" class="x-hide-display"><wicket:message key="servicemix"></wicket:message></div>
<div id="defaultMask" class="x-hide-display"><wicket:message key="mask"></wicket:message></div>
 <div id='panel'></div>
<!-- Fields required for history management -->
<form id="history-form" class="x-hidden">
    <input type="hidden" id="x-history-field" />
    <iframe id="x-history-frame"></iframe>
</form>
<script type="text/javascript">
/*global Ext */ 

function getText(txt) {
    var elt = Ext.get(txt).dom;
	var _innerText = elt.innerText;
	if (_innerText == undefined) {
  		_innerText = elt.innerHTML.replace(/<[^>]+>/g,"");
	}
	return _innerText;
}
Ext.onReady( function(){
 
  var geoserverUrl = getText('geoserverUrl');
  var sourcePanel = new Ext.ux.FeatureTypePanel({ id:'sourceLayer', title: 'Source Layer'});
  var maskPanel = new Ext.ux.FeatureTypePanel({id:'maskLayer', title: 'Mask Layer'});
  var targetPanel = new Ext.ux.FeatureTypePanel({id:'targetLayer', title: 'Target Layer'});
	
  var treeRoot = new Ext.tree.TreeNode( {
    text : 'Geoserver Layers',
    draggable:false
  });      
  var tree = new Ext.tree.TreePanel( {
    root : treeRoot,
    rootVisible : false,
    border : false,
    animate:true, 
    containerScroll: true,             
    autoScroll:true                
  });
  var root = tree.getRootNode();
  var success = function(response) {
    var namespaces = Ext.decode(response.responseText).namespaces.namespace;
    var success3 = function(response) {
      var featureTypes = Ext.decode(response.responseText).featureTypes.featureType;
      if (!featureTypes) {  return; }
      var setSource = function(href){  return sourcePanel.setCurrentFeatureType(href); };
      var setTarget = function(href){  return targetPanel.setCurrentFeatureType(href); };
      var setMask = function(href){  return maskPanel.setCurrentFeatureType(href); };
      var onContextmenu = function(node, e) {
        var menu = new Ext.menu.Menu( {
          items : [ {
            text : 'Set as Source',
            handler: setSource.createDelegate(this, [geoserverUrl + '/rest/workspaces/fifao/featuretypes/'+this.name+'.json'])
          }, '-', {
            text : 'Set as Target',
            handler: setTarget.createDelegate(this, [geoserverUrl + '/rest/workspaces/fifao/featuretypes/'+this.name+'.json'])
          }, '-', {
            text : 'Set as Mask',
            handler: setMask.createDelegate(this, [geoserverUrl + '/rest/workspaces/fifao/featuretypes/'+this.name+'.json'])
          } ]
        });
        menu.showAt(e.getXY());
      };
      for ( var i = 0; i < featureTypes.length; i++) {
        var featureType = featureTypes[i];              
        var node = new Ext.tree.TreeNode( {
          text : featureType.name,
          feature: featureType,
          listeners : {
            contextmenu : {
              fn : onContextmenu,
              scope : featureType                                                  
            }
          }
        });                          
        this.appendChild(node);
      }
    }; // End success 3
    var success2 = function(response) {
      var featureTypesURL = geoserverUrl + '/rest/workspaces/'+Ext.decode(response.responseText).namespace.prefix+'/featuretypes.json';
      Ext.Ajax.request( {
        url : featureTypesURL,
        scope : this,
        success : success3
      });
    }; // End success2
    for ( var i = 0; i < namespaces.length; i++) {
      var namespace = namespaces[i]; 
      var node = new Ext.tree.TreeNode( {
        text : namespace.name
      });
      root.appendChild(node);
      Ext.Ajax.request( {
        url : geoserverUrl + '/rest/namespaces/'+namespace.name+'.json',
        scope : node,
        success : success2
      });
    }
  }; //End success	
  var combinationPanel = new Ext.Panel({
    bodyStyle:'padding:5px 5px 0',
    region : 'center',
	title : 'Right click on the tree nodes to select layers',
	autoScroll: true,	                
	containerScroll: true,
	layout: 'column',
	items : [sourcePanel, targetPanel,  maskPanel]
  });
  
  var preserveBox = new Ext.form.Checkbox(
  {	
    id: 'preserveBox',
    name: 'preserve',
	boxLabel: 'Preserve Geometry'}
  );
  
  var optionsPanel = new Ext.Panel({
    bodyStyle:'padding:5px 5px 0',
    region : 'south',
	title : 'Combination Options',
	height: 70,
	items : [preserveBox]
  });
  
  
  var panel = new Ext.Panel({
    title: 'Source and Target',
    id: 'tab1',
	width: 750,
	height: 450,
	layoutConfig : { align : 'stretch' },
	autoScroll:true,
	layout : 'border',
	defaults : {
	  border : false,
	  flex : 1 
	},
	items : [ {
	  region : 'west',
	  title : 'Geoserver Layers',
	  width : 200,
	  autoScroll:true,
	  containerScroll: true,
	  items : tree
	  }, 
	  combinationPanel,
	  optionsPanel
	],
    bbar : [
      '->', // Fill
	  {
        text    : '<img src="resources/it.geosolutions.figis.client.admin.SourceAndTarget/$up$/img/icons/silk/disk.png"/> Save Combination',
        handler : function() {
          var apiUrl = getText('apiUrl');
          
          var defaultMask = getText('defaultMask');
          var sourceValue = sourcePanel.getFeatureType();
          var targetValue = targetPanel.getFeatureType();
          var maskValue =  maskPanel.getFeatureType();
          var sourceCodeField = sourcePanel.getCodeField();
          var targetCodeField = targetPanel.getCodeField();  
                          
          var updateResults = function(result){
            Ext.example.msg(result.status, 'Combination successfully saved', '');
            var grid = Ext.getCmp('tab2');
			grid.store.reload();	
          };        
          Ext.ux.JSONP.request(apiUrl+"/iedata/", {
            callbackKey: 'jsoncallback',
            params: {
              service: 'addCombination',
              source: sourceValue,
              target: targetValue,
              mask: maskValue,  
              source_code:  sourceCodeField,
              target_code: targetCodeField,
              preserve_target: preserveBox.getValue()              
            },
            callback: updateResults
          });
        }
      }
    ]
  }); 
var combinationRecordDef = Ext.data.Record.create([
    {name: 'id'},
    {name: 'source'},
    {name: 'sourceCode'},
    {name: 'mask'},
    {name: 'target'},
    {name: 'targetCode'},
    {name: 'status'},
    {name: 'preserveTarget'}
]);

var combinationsReader = new Ext.data.JsonReader({
    root: "combinations",                // The property which contains an Array of row objects
    id: "id"                     // The property within each row object that provides an ID for the record (optional)
}, combinationRecordDef);


    var apiUrl = getText('apiUrl');   
    var combinationsProxy = new Ext.data.ScriptTagProxy({
          url: apiUrl + "/iedata/?service=getCombinations",
          callback: 'jsoncallback'
          });
          
    var combinationsStore = new Ext.data.Store({
            reader: combinationsReader,
            proxy: combinationsProxy
        });
    combinationsStore.load();
    // create the Grid
    var combinationsGrid = new Ext.grid.GridPanel({
        title: 'Managing of Combinations',
        id: 'tab2',
        store: combinationsStore,
        columns: [
            {header: "Id", sortable: true, width:40,dataIndex: 'id'},
            {header: "Source", width: 120, sortable: true, dataIndex: 'source'},
            {header: "Source Code", width: 80, sortable: true, dataIndex: 'sourceCode'},
            {header: "Mask", width: 120, sortable: true, dataIndex: 'mask'},
            {header: "Target", width: 120, sortable: true, dataIndex: 'target'},
            {header: "Target Code", width: 80, sortable: true, dataIndex: 'targetCode'},
            {header: "Preserve Target", width: 80, sortable: true, dataIndex: 'preserveTarget'},
            {header: "Status", width: 80, sortable: true, dataIndex: 'status'}
        ],
        stripeRows: true,
        height:350,
        width:600,
        bbar: new Ext.PagingToolbar({
            buttons: [{
		        text: '<img src="resources/it.geosolutions.figis.client.admin.SourceAndTarget/$up$/img/icons/silk/delete.png"/>Delete',
			    handler: function(btn, ev) {
			              var apiUrl = getText('apiUrl');
			              var theId = Ext.getCmp('tab2').getSelectionModel().selections.items[0].json.id;
				          var updateResults = function(result){
				            Ext.example.msg(result.status, 'Combination ' + theId + ' deleted', '');
				            var grid = Ext.getCmp('tab2');
				            grid.store.reload();				            
				          };        
				          Ext.ux.JSONP.request(apiUrl+"/iedata/", {
				            callbackKey: 'jsoncallback',
				            params: {
				              service: 'removeCombination',
				              id: theId                 
				            },
				            callback: updateResults
				          }); 
				       },
                 scope: this
               },{
               
		        text: '<img src="resources/it.geosolutions.figis.client.admin.SourceAndTarget/$up$/img/icons/silk/tick.png"/>Enable',
			    handler: function(btn, ev) {
			              var apiUrl = getText('apiUrl');
			              var theId = Ext.getCmp('tab2').getSelectionModel().selections.items[0].json.id;
				          var updateResults = function(result){
				            Ext.example.msg(result.status, 'Combination ' + theId + ' enabled', '');
				            var grid = Ext.getCmp('tab2');
				            grid.store.reload();				            
				          };        
				          Ext.ux.JSONP.request(apiUrl+"/iedata/", {
				            callbackKey: 'jsoncallback',
				            params: {
				              service: 'setCombination',
				              id: theId,
				              enabled: true             
				            },
				            callback: updateResults
				          }); 
				       },
                 scope: this
               },{
               
		        text: '<img src="resources/it.geosolutions.figis.client.admin.SourceAndTarget/$up$/img/icons/silk/error.png"/>Disable',
			    handler: function(btn, ev) {
			              var apiUrl = getText('apiUrl');
			              var theId = Ext.getCmp('tab2').getSelectionModel().selections.items[0].json.id;
				          var updateResults = function(result){
				            Ext.example.msg(result.status, 'Combination ' + theId + ' disabled', '');
				            var grid = Ext.getCmp('tab2');
				            grid.store.reload();				            
				          };        
				          Ext.ux.JSONP.request(apiUrl+"/iedata/", {
				            callbackKey: 'jsoncallback',
				            params: {
				              service: 'setCombination',
				              id: theId,
				              enabled: false               
				            },
				            callback: updateResults
				          }); 
				       },
                 scope: this            
            }],
            store: combinationsStore,
            pageSize: 25
        })
    });

var RecordDef = Ext.data.Record.create([
    {name: 'id'},
    {name: 'duration'},    
    {name: 'status'},
    {name: 'started'},
    {name: 'finished'}
]);

var computationsReader = new Ext.data.JsonReader({
    root: "computations",                // The property which contains an Array of row objects
    id: "id"                     // The property within each row object that provides an ID for the record (optional)
}, RecordDef);




    var computationsProxy = new Ext.data.ScriptTagProxy({
          url: apiUrl + "/iedata/?service=getComputations" ,
          callback: 'jsoncallback'
          });
    var computationsStore = new Ext.data.Store({
            reader: computationsReader,
            proxy: computationsProxy,
            sortInfo: { field: "id", direction: "DESC" }
        });
    computationsStore.load();
    var logGrid = new Ext.grid.GridPanel({
        title: 'Computations Log',
        id: 'tab3',
        store: computationsStore,
        cm: new Ext.grid.ColumnModel({
            defaults: {
                width: 20,
                sortable: true
            },
            columns: [
                {id:'id',header: "id", width: 10, dataIndex: 'id'},
                {header: "Started", dataIndex: 'started'},
                {header: "Finished", dataIndex: 'finished'},
                {header: "Status", dataIndex: 'status'} 
            ]
        }),
        viewConfig: {
            forceFit:true
        },        
        width: 600,
        height: 300,
        iconCls: 'icon-grid',
        bbar: new Ext.PagingToolbar({
           store: computationsStore,
           pageSize: 25
        })
    });

  // The only requirement for this to work is that you must have a hidden field and
  // an iframe available in the page with ids corresponding to Ext.History.fieldId
  // and Ext.History.iframeId.  See history.html for an example.
  Ext.History.init();
    
  // Needed if you want to handle history for multiple components in the same page.
  // Should be something that won't be in component ids.
  var tokenDelimiter = ':';
  var rebuildFn = function(btn, e){
      var apiUrl = getText('apiUrl');  
      Ext.example.msg('DONE', 'Starting Computation', '');
      var rebuildProxy = new Ext.data.ScriptTagProxy({
          url: apiUrl + "/ieops/?service=rebuildAll" ,
          callback: 'jsoncallback'
      });
      var rebuildRecord = Ext.data.Record.create([
          {name: 'id'}
      ]);

      var rebuildReader = new Ext.data.JsonReader({
        root: "rebuild",  
        id: "id" }, rebuildRecord);
          var rebuildStore = new Ext.data.Store({
            reader: rebuildReader,
            proxy: rebuildProxy
        });
    rebuildStore.load();
  };
  var tp = new Ext.TabPanel({
    renderTo: 'panel',
    id: 'main-tabs',
    width: 800,
    height: 450,
    activeTab: 0, 
    tabPosition:'bottom',
    tbar: [{
        text: 'Batch Runner Status: *Idle*',
        disabled: true
      },{
	    text: '<img src="resources/it.geosolutions.figis.client.admin.SourceAndTarget/$up$/img/computations.png"/> Start batch computation',
	    handler: rebuildFn.createDelegate(this)
    }],   
    items: [panel, combinationsGrid, logGrid],  
  
    listeners: {
      'tabchange': function(tabPanel, tab){
        // Ignore tab1 since it is a separate tab panel and we're managing history for it also.
        // We'll use its handler instead in that case so we don't get duplicate nav events for sub tabs.
        if(tab.id != 'tab1'){
          Ext.History.add(tabPanel.id + tokenDelimiter + tab.id);
        }
      }
    }
  });
   	
  // Handle this change event in order to restore the UI to the appropriate history state
  Ext.History.on('change', function(token){
    if(token){
      var parts = token.split(tokenDelimiter);
      var tabPanel = Ext.getCmp(parts[0]);
      var tabId = parts[1];
      tabPanel.show();
      tabPanel.setActiveTab(tabId);
    }else{
      // This is the initial default state.  Necessary if you navigate starting from the
      // page without any existing history token params and go back to the start state.
      tp.setActiveTab(0);
      tp.getItem(0).setActiveTab(0);
    }
  });
    
  Ext.Ajax.request( {
    url : geoserverUrl + '/rest/namespaces.json',
    success : success
  });

});//End Ext.onReady

</script>


</wicket:extend>

</body>
</html>